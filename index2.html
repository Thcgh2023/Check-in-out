<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check In-Out</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <style>
      body {
        font-family: 'Noto Sans Thai', sans-serif;
      }
    </style>
<script>
    window.onload = function () {
        initializeLiff(),getUserProfile();
    };

    async function initializeLiff() {
        await liff.init({ liffId: '2002689552-4P73J9mp' }); // Replace with your LIFF ID

        if (liff.isLoggedIn()) {
            getUserProfile();
        } else {
            liff.login();
        }
    }

    async function getUserProfile() {
        try {
            const profile = await liff.getProfile();
            document.getElementById('userId').value = profile.userId;
            document.getElementById('displayName').value = profile.displayName;
            // Trigger search when user ID is retrieved
            searchData();
        } catch (error) {
            console.error('Error getting profile data:', error);
        }
    }
</script>
</head>
<body class="bg-white text-base">
    <div class="max-w-md mx-auto p-4">
        
        <div class="p-2">
            <span><b>‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ</b></span>
            <input type="text" id="displayName" name="displayName" class="text-[#1F3D77] border-none w-[65%] bg-transparent focus:outline-none focus:ring-0">
        </div>

        <div class="banner mb-3 text-white p-5 font-bold bg-gradient-to-r from-[rgb(31,61,119)] to-[rgb(36,170,223)] mt-2.5 rounded-lg flex justify-between items-center">
            <div class="max-w-[25%]">
                <img class="w-full rounded-md" src="https://lh5.googleusercontent.com/d/1cf_tt_KvsNdZTJJ4VIYYJWchCCH8yn6s" alt="THCGS">
            </div>
            <div class="text-right">
                <div id="date" class="text-base"></div>
                <div id="time" class="text-2xl"></div>
                <input type="date" id="todayInput" name="todayInput" readonly class="absolute -left-[9999px]">
                <input type="time" id="currentTime" name="currentTime" class="hidden">
            </div>
        </div>
        
        <div id="step1">
            <div class="state p-2">
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">co_present</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="columnBData" placeholder="‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•" name="columnBData" required>
                </div>
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">pin</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="roleInput" placeholder="‡∏£‡∏´‡∏±‡∏™ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" name="roleInput" required>
                </div>
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">editor_choice</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="columnDData" placeholder="‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á" name="columnDData" required>
                </div>
                
                <div class="flex flex-col space-y-2 my-4">
                    <input type="radio" id="radio-three" name="switch-jop" value="‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô" class="peer/in hidden" />
                    <label for="radio-three" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/in:bg-[#1F3D77] peer-checked/in:text-white peer-checked/in:border-blue-200">‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô</label>
                    
                    <input type="radio" id="radio-four" name="switch-jop" value="‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô" class="peer/mid hidden" />
                    <label for="radio-four" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/mid:bg-[#1F3D77] peer-checked/mid:text-white peer-checked/mid:border-blue-200">‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ß‡∏±‡∏ô</label>
                    
                    <input type="radio" id="radio-five" name="switch-jop" value="‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô" class="peer/out hidden" />
                    <label for="radio-five" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/out:bg-[#1F3D77] peer-checked/out:text-white peer-checked/out:border-blue-200">‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô</label>
                </div>
                
                <input type="hidden" id="jobInput" name="jobInput" required>
                <textarea class="w-full p-3 border border-[#1F3D77] rounded-md" placeholder="Note" id="noteInput"></textarea><br>
            </div>
            <div class="flex flex-row-reverse">
                <button class="bg-[#1F3D77] text-white py-3 px-4 w-32 rounded-md mt-3" onclick="nextStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
            <div id="parentDiv" class="hidden">
                <input type="text" id="displayName" name="displayName" class="visible">
                <table id="data-table" class="visible">
                    <input type="text" id="userId" name="userId" oninput="searchData()" class="visible" />
                    <input type="text" id="columnAData" name="columnAData" class="hidden" />
                </table>
            </div>
        </div>

        <div id="step2" class="border border-gray-200 p-4 hidden text-center bg-white rounded-lg">
            <div class="max-w-full mx-auto">
                <video id="camera-preview" class="w-[70%] h-auto mx-auto" autoplay playsinline poster="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/330px-No-Image-Placeholder.svg.png?20200912122019"></video>
                <br>
                <img id="preview" class="w-[70%] h-auto mx-auto" alt="" required>
                <div class="mb-4">
                    <button class="bg-yellow-400 text-black py-2.5 w-36 rounded-full m-2" id="start-camera-btn">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á</button>
                    <button class="bg-green-600 text-white py-2.5 w-36 rounded-full m-2" id="capture-btn" disabled>‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ</button>
                </div>
            </div>
            <div class="flex justify-between mt-4">
                <button class="bg-gray-400 text-white py-3 px-4 w-32 rounded-md m-2" onclick="prevStep()">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button class="bg-[#1F3D77] text-white py-3 px-4 w-32 rounded-md m-2" onclick="checkPictureAndNextStep()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>

        <div id="step3" class="border border-gray-200 p-4 hidden text-center bg-white rounded-lg">
            <div class="submit">
                <div class="p-2 mb-2">
                    <button type="button" onclick="getLocation()" class="bg-[#1F3D77] text-white py-3 px-6 rounded-md">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</button>
                </div>
                <div id="locationInfo" name="locationInfo" class="flex flex-row justify-center space-x-4">
                    <p id="latitude">Latitude: </p>
                    <p id="longitude">Longitude: </p>
                </div>
                <p id="fullAddress">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</p>
                <input type="hidden" id="latitudeInput" name="latitudeInput">
                <input type="hidden" id="longitudeInput" name="longitudeInput">
                <input type="hidden" id="fullAddressInput" name="fullAddressInput" required>
            </div>
            <br>
            <iframe id="mapIframe" class="p-2 w-full h-60 border-0" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>
            <div class="flex justify-between mt-4">
                <button class="bg-gray-400 text-white py-3 px-4 w-32 rounded-md" onclick="prevStep()">‡∏Å‡∏•‡∏±‡∏ö</button>
                <button id="submitButton" class="bg-red-700 text-white py-3 px-4 w-32 rounded-md" onclick="submitForm()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script>
        // Global variables and selectors
        let url = "https://script.google.com/macros/s/AKfycbzcHv6cB6Nu0gU1-j5JwYjvBIenViYLURqr2KC2DfODrFvb2D8jGNelBp9wGLyo6cMJ/exec";
        let columnBData = document.querySelector("#columnBData");
        let roleInput = document.querySelector("#roleInput");
        let jobInput = document.querySelector("#jobInput");
        let noteInput = document.querySelector("#noteInput");
        let todayInput = document.querySelector("#todayInput");
        let currentTime = document.querySelector("#currentTime");
        let latitudeInput = document.querySelector("#latitudeInput");
        let longitudeInput = document.querySelector("#longitudeInput");
        let fullAddressInput = document.querySelector("#fullAddressInput");
        let userId = document.querySelector("#userId");
        let preview = document.getElementById('preview');

        // Function to get current time in HH:MM format for Bangkok
        function getCurrentTimeInBangkok() {
            const now = new Date();
            const bangkokTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
            const hours = String(bangkokTime.getHours()).padStart(2, '0');
            const minutes = String(bangkokTime.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }


        // Function to get today's date in DD-MM-YYYY format
        function getFormattedDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            // üëá ‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á day, month, year ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Ñ‡∏±‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô -
            return `${day}-${month}-${year}`; 
        }


        // --- Form Submission Logic ---
        function submitForm() {
            if (!columnBData.value || !roleInput.value || !jobInput.value || !latitudeInput.value || !longitudeInput.value) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (*) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                return;
            }

            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: '‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('submitButton').disabled = true;
                    Swal.fire({
                        title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                        text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...',
                        showConfirmButton: false,
                        allowOutsideClick: false,
                        willOpen: () => { Swal.showLoading(); }
                    });

                    // 1. Get the current time at the exact moment of submission
                    const submissionTime = getCurrentTimeInBangkok();

                    // 2. Update the hidden input's value for the Flex Message
                    currentTime.value = submissionTime;

                    let spt = preview.src.split("base64,")[1];
                    let obj = {
                        base64: spt,
                        name: columnBData.value,
                        role: roleInput.value,
                        job: jobInput.value,
                        note: noteInput.value,
                        today: todayInput.value,
                        time: submissionTime, // 3. Use the fresh timestamp for backend
                        lat: latitudeInput.value,
                        long: longitudeInput.value,
                        address: fullAddressInput.value,
                        user: userId.value
                    };

                    fetch(url, {
                        method: "POST",
                        body: JSON.stringify(obj),
                    })
                    .then(response => response.text())
                    .then(data => {
                        Swal.close();
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!', 'success').then(() => {
                            sendFlexMessage();
                            console.log(data);
                        });
                    })
                    .catch(error => {
                        Swal.close();
                        Swal.fire('Error!', 'Form submission failed. Please try again.', 'error').then(() => {
                            document.getElementById('submitButton').disabled = false;
                        });
                        console.error(error);
                    });
                }
            });
        }
        
        // --- LIFF & Flex Message Logic ---
async function sendFlexMessage() {
    try {
        // --- 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message ---
        const displayName = columnBData.value || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        const employeeId = roleInput.value || '(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)';
        const jobStatus = jobInput.value || '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤';
        const recordedTime = currentTime.value || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤)';
        const recordedDate = todayInput.value || '(‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà)';
        const location = fullAddressInput.value || '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏™‡∏î‡∏á ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢';

        let jobColor = '#000000FF'; // Default color
        if (jobStatus === '‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô') jobColor = '#0D9608FF'; // Green
        else if (jobStatus === '‡∏≠‡∏≠‡∏Å‡∏á‡∏≤‡∏ô') jobColor = '#EF2F14FF'; // Red

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ liff ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞ login ‡πÅ‡∏•‡πâ‡∏ß
        if (!liff.isLoggedIn()) {
            console.error("LIFF is not logged in. Cannot send message.");
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'LIFF ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏≠‡∏¢‡∏π‡πà ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
            return;
        }

        // --- 2. ‡∏™‡∏£‡πâ‡∏≤‡∏á Object ‡∏Ç‡∏≠‡∏á Flex Message ---()
        const flexMessage = {
            type: 'flex',
            altText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤',
            contents: {
                type: 'bubble',
                direction: 'ltr',
                body: {
                    type: 'box',
                    layout: 'vertical',
                    spacing: 'md',
                    contents: [
                        {
                            type: 'box',
                            layout: 'horizontal',
                            contents: [
                                { type: 'text', text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤', weight: 'bold', size: 'md', align: 'start', margin: 'sm' },
                                { type: 'text', text: ` ${jobStatus}`, weight: 'bold', size: 'md', color: jobColor, align: 'end' }
                            ]
                        },
                        { type: 'separator' },
                        {
                            type: 'box',
                            layout: 'vertical',
                            spacing: 'sm',
                            contents: [
                                {
                                    type: 'box', layout: 'baseline', contents: [
                                        { type: 'text', text: '‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', weight: 'bold', size: 'sm', margin: 'sm' },
                                        { type: 'text', text: displayName, size: 'sm', color: '#000000FF', align: 'end', wrap: true }
                                    ]
                                },
                                {
                                    type: 'box', layout: 'baseline', contents: [
                                        { type: 'text', text: '‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô', weight: 'bold', size: 'sm', flex: 0, margin: 'sm' },
                                        { type: 'text', text: employeeId, size: 'sm', color: '#000000FF', align: 'end', wrap: true }
                                    ]
                                }
                            ]
                        },
                        { type: 'separator' },
                        {
                            type: 'box',
                            layout: 'vertical',
                            contents: [
                                {
                                    type: 'box', layout: 'baseline', contents: [
                                        { type: 'text', text: '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', weight: 'bold' },
                                        { type: 'text', text: recordedDate, weight: 'bold', align: 'end' }
                                    ]
                                },
                                {
                                    type: 'box', layout: 'baseline', contents: [
                                        { type: 'text', text: '‡πÄ‡∏ß‡∏•‡∏≤', weight: 'bold' },
                                        { type: 'text', text: recordedTime, weight: 'bold', size: 'xl', color: '#EF2F14FF', align: 'end' }
                                    ]
                                }
                            ]
                        },
                        { type: 'separator' },
                        {
                            type: 'box',
                            layout: 'vertical',
                            spacing: 'xs',
                            margin: 'sm',
                            contents: [
                                { type: 'text', text: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà', weight: 'bold', size: 'sm', margin: 'md' },
                                { type: 'text', text: location, wrap: true }
                            ]
                        }
                    ]
                }
            }
        };
        
        // --- 3. ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF ---
        console.log("Attempting to send Flex Message with data:", flexMessage);
        await liff.sendMessages([flexMessage]);
        console.log("Flex Message sent successfully.");
        liff.closeWindow();

    } catch (error) {
        // --- 4. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ---
        console.error("Failed to send Flex Message:", error);
        Swal.fire('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`, 'error');
        // ‡πÑ‡∏°‡πà‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á LIFF ‡∏´‡∏≤‡∏Å‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    }
}

        // --- Event Listeners and Initializers ---
        document.addEventListener("DOMContentLoaded", function () {
            // Set initial date
            todayInput.value = getFormattedDate();

            // Camera elements
            const video = document.getElementById("camera-preview");
            const startCameraBtn = document.getElementById("start-camera-btn");
            const captureBtn = document.getElementById("capture-btn");
            const previewImage = document.getElementById("preview");
            let stream;

            startCameraBtn.addEventListener("click", () => {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(videoStream => {
                        stream = videoStream;
                        video.srcObject = videoStream;
                        captureBtn.disabled = false;
                        video.style.display = "block";
                    })
                    .catch(error => console.error("Error accessing the camera: ", error));
            });

            captureBtn.addEventListener("click", () => {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
                previewImage.src = canvas.toDataURL("image/png");
                video.style.display = "none";
            });

            // Radio button job type listener
            document.querySelectorAll('input[name="switch-jop"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    jobInput.value = this.value;
                });
            });

            // Update clock display every second
            setInterval(() => {
                const now = new Date();
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false, timeZone: 'Asia/Bangkok' };
                document.getElementById('date').textContent = now.toLocaleDateString('th-TH', dateOptions);
                document.getElementById('time').textContent = now.toLocaleTimeString('en-US', timeOptions);
            }, 1000);
        });

        // --- Geolocation Logic ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(displayLocation, 
                    (error) => alert(`Geolocation error: ${error.message}`));
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function displayLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            latitudeInput.value = latitude;
            longitudeInput.value = longitude;
            document.getElementById("latitude").innerText = `Latitude: ${latitude.toFixed(6)}`;
            document.getElementById("longitude").innerText = `Longitude: ${longitude.toFixed(6)}`;
            
            const reverseGeocodingUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
            fetch(reverseGeocodingUrl)
                .then(response => response.json())
                .then(data => {
                    const fullAddress = data.display_name || "Unable to retrieve full address.";
                    document.getElementById("fullAddress").innerText = `‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: ${fullAddress}`;
                    fullAddressInput.value = fullAddress;
                })
                .catch(error => {
                    console.error("Error fetching reverse geocoding data:", error);
                    document.getElementById("fullAddress").innerText = "Error fetching address.";
                });

            document.getElementById("mapIframe").src = `https://maps.google.com/maps?q=${latitude},${longitude}&output=embed`;
        }
        
        // --- Step Navigation ---
        let currentStep = 1;
        function nextStep() {
            if (currentStep < 3) {
                document.getElementById(`step${currentStep}`).style.display = 'none';
                currentStep++;
                document.getElementById(`step${currentStep}`).style.display = 'block';
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).style.display = 'none';
                currentStep--;
                document.getElementById(`step${currentStep}`).style.display = 'block';
            }
        }

        function checkPictureAndNextStep() {
            const capturedImage = document.getElementById('preview').src;
            if (!capturedImage || capturedImage.includes('No-Image-Placeholder')) {
                Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ', 'warning');
            } else {
                nextStep();
            }
        }

        // --- Google Sheets Data Fetching for User Info ---
        const apimapKey = 'AIzaSyAHc1bZMPXE9NehuqgmjuWPsXpGds9wUCE';
        const spreadsheet2Id = '1gErfBELM6hSGTqx0xapkAfdhRjZ_BK7zhXMdRcLWm2w';
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheet2Id}/values/MEMBER?key=${apimapKey}`;

        async function fetchData() {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                const table = document.getElementById('data-table');
                table.innerHTML = '';
                data.values.forEach(row => {
                    const tr = document.createElement('tr');
                    row.forEach(cell => {
                        const td = document.createElement('td');
                        td.textContent = cell;
                        tr.appendChild(td);
                    });
                    table.appendChild(tr);
                });
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        fetchData();

        function searchData() {
            const filter = document.getElementById('userId').value.toUpperCase();
            const table = document.getElementById('data-table');
            const rows = table.getElementsByTagName('tr');

            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 0 && (cells[0].textContent || cells[0].innerText).toUpperCase().indexOf(filter) > -1) {
                    document.getElementById('columnBData').value = cells[1] ? (cells[1].textContent || cells[1].innerText) : '';
                    document.getElementById('roleInput').value = cells[2] ? (cells[2].textContent || cells[2].innerText) : '';
                    document.getElementById('columnDData').value = cells[3] ? (cells[3].textContent || cells[3].innerText) : '';
                    break;
                }
            }
        }
    </script>
</body>
</html>
