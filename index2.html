<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check In-Out</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <style>
      body {
        font-family: 'Noto Sans Thai', sans-serif;
      }
    </style>
</head>
<body class="bg-white text-base">
    <div class="max-w-md mx-auto p-4">
        
        <div class="p-2">
            <span><b>สวัสดี</b></span>
            <input type="text" id="displayName" name="displayName" class="text-[#1F3D77] border-none w-[65%] bg-transparent focus:outline-none focus:ring-0" readonly>
        </div>

        <div class="banner mb-3 text-white p-5 font-bold bg-gradient-to-r from-[rgb(31,61,119)] to-[rgb(36,170,223)] mt-2.5 rounded-lg flex justify-between items-center">
            <div class="max-w-[25%]">
                <img class="w-full rounded-md" src="https://lh5.googleusercontent.com/d/1cf_tt_KvsNdZTJJ4VIYYJWchCCH8yn6s" alt="THCGS">
            </div>
            <div class="text-right">
                <div id="date" class="text-base"></div>
                <div id="time" class="text-2xl"></div>
                <input type="date" id="todayInput" name="todayInput" readonly class="absolute -left-[9999px]">
                <input type="time" id="currentTime" name="currentTime" class="hidden">
            </div>
        </div>
        
        <div id="step1">
            <div class="state p-2">
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">co_present</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="columnBData" placeholder="ชื่อ - สกุล" name="columnBData" required>
                </div>
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">pin</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="roleInput" placeholder="รหัส พนักงาน" name="roleInput" required>
                </div>
                <div class="relative w-full mb-3">
                    <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-[#1F3D77]">editor_choice</span>
                    <input type="text" class="w-full text-left border border-gray-300 rounded-md py-2.5 pl-12 pr-4 focus:border-[#1F3D77] focus:ring-[#1F3D77]" id="columnDData" placeholder="ตำแหน่ง" name="columnDData" required>
                </div>
                
                <div class="flex flex-col space-y-2 my-4">
                    <input type="radio" id="radio-three" name="switch-jop" value="เข้างาน" class="peer/in hidden" />
                    <label for="radio-three" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/in:bg-[#1F3D77] peer-checked/in:text-white peer-checked/in:border-blue-200">เข้างาน</label>
                    <input type="radio" id="radio-four" name="switch-jop" value="ระหว่างวัน" class="peer/mid hidden" />
                    <label for="radio-four" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/mid:bg-[#1F3D77] peer-checked/mid:text-white peer-checked/mid:border-blue-200">ระหว่างวัน</label>
                    <input type="radio" id="radio-five" name="switch-jop" value="ออกงาน" class="peer/out hidden" />
                    <label for="radio-five" class="text-center p-2 rounded-md border border-green-500 text-teal-500 font-bold cursor-pointer transition-colors duration-100 ease-in-out hover:bg-gray-100 peer-checked/out:bg-[#1F3D77] peer-checked/out:text-white peer-checked/out:border-blue-200">ออกงาน</label>
                </div>
                
                <input type="hidden" id="jobInput" name="jobInput" required>
                <textarea class="w-full p-3 border border-[#1F3D77] rounded-md" placeholder="Note" id="noteInput"></textarea><br>
            </div>
            <div class="flex flex-row-reverse">
                <button class="bg-[#1F3D77] text-white py-3 px-4 w-32 rounded-md mt-3" onclick="nextStep()">ถัดไป</button>
            </div>
            <div id="parentDiv" class="hidden">
                <table id="data-table">
                    <input type="text" id="userId" name="userId" oninput="searchData()" />
                    <input type="text" id="columnAData" name="columnAData" />
                </table>
            </div>
        </div>

        <div id="step2" class="border border-gray-200 p-4 hidden text-center bg-white rounded-lg">
            <div class="max-w-full mx-auto">
                <video id="camera-preview" class="w-[70%] h-auto mx-auto" autoplay playsinline poster="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/330px-No-Image-Placeholder.svg.png?20200912122019"></video>
                <br>
                <img id="preview" class="w-[70%] h-auto mx-auto" alt="" required>
                <div class="mb-4">
                    <button class="bg-yellow-400 text-black py-2.5 w-36 rounded-full m-2" id="start-camera-btn">เริ่มเปิดกล้อง</button>
                    <button class="bg-green-600 text-white py-2.5 w-36 rounded-full m-2" id="capture-btn" disabled>ถ่ายรูป</button>
                </div>
            </div>
            <div class="flex justify-between mt-4">
                <button class="bg-gray-400 text-white py-3 px-4 w-32 rounded-md m-2" onclick="prevStep()">กลับ</button>
                <button class="bg-[#1F3D77] text-white py-3 px-4 w-32 rounded-md m-2" onclick="checkPictureAndNextStep()">ถัดไป</button>
            </div>
        </div>

        <div id="step3" class="border border-gray-200 p-4 hidden text-center bg-white rounded-lg">
            <div class="submit">
                <div class="p-2 mb-2">
                    <button type="button" onclick="getLocation()" class="bg-[#1F3D77] text-white py-3 px-6 rounded-md">กดเพื่อยืนยันที่อยู่ของคุณ</button>
                </div>
                <div id="locationInfo" name="locationInfo" class="flex flex-row justify-center space-x-4">
                    <p id="latitude">Latitude: </p>
                    <p id="longitude">Longitude: </p>
                </div>
                <p id="fullAddress">สถานที่</p>
                <input type="hidden" id="latitudeInput" name="latitudeInput">
                <input type="hidden" id="longitudeInput" name="longitudeInput">
                <input type="hidden" id="fullAddressInput" name="fullAddressInput" required>
            </div>
            <br>
            <iframe id="mapIframe" class="p-2 w-full h-60 border-0" allowfullscreen="" aria-hidden="false" tabindex="0"></iframe>
            <div class="flex justify-between mt-4">
                <button class="bg-gray-400 text-white py-3 px-4 w-32 rounded-md" onclick="prevStep()">กลับ</button>
                <button id="submitButton" class="bg-red-700 text-white py-3 px-4 w-32 rounded-md" onclick="submitForm()">บันทึกข้อมูล</button>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script>
        // --- Global Variables ---
        let url = "https://script.google.com/macros/s/AKfycbzcHv6cB6Nu0gU1-j5JwYjvBIenViYLURqr2KC2DfODrFvb2D8jGNelBp9wGLyo6cMJ/exec";
        let columnBData = document.querySelector("#columnBData");
        let roleInput = document.querySelector("#roleInput");
        let jobInput = document.querySelector("#jobInput");
        let noteInput = document.querySelector("#noteInput");
        let todayInput = document.querySelector("#todayInput");
        let currentTime = document.querySelector("#currentTime");
        let latitudeInput = document.querySelector("#latitudeInput");
        let longitudeInput = document.querySelector("#longitudeInput");
        let fullAddressInput = document.querySelector("#fullAddressInput");
        let userId = document.querySelector("#userId");
        let preview = document.getElementById('preview');

        // --- LIFF Initialization ---
        async function initializeLiff() {
            try {
                await liff.init({ liffId: '2002689552-Ar2zkXgJ' });
                if (liff.isLoggedIn()) {
                    getUserProfile();
                } else {
                    liff.login();
                }
            } catch (error) {
                console.error('LIFF Initialization failed.', error);
                alert('LIFF Initialization failed. Please try again.');
            }
        }

        async function getUserProfile() {
            try {
                const profile = await liff.getProfile();
                document.getElementById('userId').value = profile.userId;
                document.getElementById('displayName').value = profile.displayName;
                searchData();
            } catch (error) {
                console.error('Error getting profile data:', error);
            }
        }
        
        // --- Date & Time ---
        function getFormattedDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getFormattedDateForDisplay() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${day}-${month}-${year}`;
        }

        function getCurrentTimeInBangkok() {
            const now = new Date();
            const bangkokTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Bangkok' }));
            const hours = String(bangkokTime.getHours()).padStart(2, '0');
            const minutes = String(bangkokTime.getMinutes()).padStart(2, '0');
            return `${hours}:${minutes}`;
        }

        // --- Form & Data Submission ---
        function submitForm() {
            if (!columnBData.value || !roleInput.value || !jobInput.value || !latitudeInput.value || !longitudeInput.value) {
                Swal.fire('แจ้งเตือน!', 'กรุณากรอกข้อมูลที่จำเป็น (*) ให้ครบถ้วน', 'warning');
                return;
            }

            Swal.fire({
                title: 'ยืนยันการส่งข้อมูล', text: 'คุณแน่ใจหรือไม่ที่ต้องการส่งข้อมูล?', icon: 'question',
                showCancelButton: true, confirmButtonText: 'ยืนยัน', cancelButtonText: 'ยกเลิก',
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById('submitButton').disabled = true;
                    Swal.fire({
                        title: 'กำลังบันทึกข้อมูล', text: 'กรุณารอสักครู่...', showConfirmButton: false,
                        allowOutsideClick: false, willOpen: () => { Swal.showLoading(); }
                    });

                    const submissionTime = getCurrentTimeInBangkok();
                    currentTime.value = submissionTime;

                    let spt = preview.src.split("base64,")[1];
                    let obj = {
                        base64: spt, name: columnBData.value, role: roleInput.value,
                        job: jobInput.value, note: noteInput.value, today: todayInput.value,
                        time: submissionTime, lat: latitudeInput.value, long: longitudeInput.value,
                        address: fullAddressInput.value, user: userId.value
                    };

                    fetch(url, { method: "POST", body: JSON.stringify(obj) })
                        .then(response => response.text())
                        .then(data => {
                            Swal.close();
                            Swal.fire('สำเร็จ!', 'บันทึกข้อมูลของคุณเรียบร้อย!', 'success').then(() => {
                                sendFlexMessage(); console.log(data);
                            });
                        })
                        .catch(error => {
                            Swal.close();
                            Swal.fire('Error!', 'Form submission failed. Please try again.', 'error').then(() => {
                                document.getElementById('submitButton').disabled = false;
                            });
                            console.error(error);
                        });
                }
            });
        }
        
        // --- Flex Message ---
        async function sendFlexMessage() {
            try {
                const displayName = columnBData.value || '(ไม่มีข้อมูล)';
                const employeeId = roleInput.value || '(ไม่มีข้อมูล)';
                const jobStatus = jobInput.value || 'บันทึกเวลา';
                const recordedTime = currentTime.value || '(ไม่พบบันทึกเวลา)';
                const recordedDate = getFormattedDateForDisplay() || '(ไม่พบบันทึกวันที่)';
                const location = fullAddressInput.value || 'ข้อมูลไม่พร้อมแสดง บันทึกพิกัดของคุณเรียบร้อย';

                let jobColor = '#000000FF';
                if (jobStatus === 'เข้างาน') jobColor = '#0D9608FF';
                else if (jobStatus === 'ออกงาน') jobColor = '#EF2F14FF';

                if (!liff.isLoggedIn()) {
                    Swal.fire('เกิดข้อผิดพลาด', 'LIFF ไม่ได้ล็อกอินอยู่ กรุณาเปิดฟอร์มใหม่อีกครั้ง', 'error');
                    return;
                }

                const flexMessage = { type: 'flex', altText: 'บันทึกเวลา', contents: { type: 'bubble', direction: 'ltr', body: { type: 'box', layout: 'vertical', spacing: 'md', contents: [ { type: 'box', layout: 'horizontal', contents: [ { type: 'text', text: 'บันทึกเวลา', weight: 'bold', size: 'md', align: 'start', margin: 'sm' }, { type: 'text', text: ` ${jobStatus}`, weight: 'bold', size: 'md', color: jobColor, align: 'end' } ] }, { type: 'separator' }, { type: 'box', layout: 'vertical', spacing: 'sm', contents: [ { type: 'box', layout: 'baseline', contents: [ { type: 'text', text: 'ชื่อพนักงาน', weight: 'bold', size: 'sm', margin: 'sm' }, { type: 'text', text: displayName, size: 'sm', color: '#000000FF', align: 'end', wrap: true } ] }, { type: 'box', layout: 'baseline', contents: [ { type: 'text', text: 'รหัสพนักงาน', weight: 'bold', size: 'sm', flex: 0, margin: 'sm' }, { type: 'text', text: employeeId, size: 'sm', color: '#000000FF', align: 'end', wrap: true } ] } ] }, { type: 'separator' }, { type: 'box', layout: 'vertical', contents: [ { type: 'box', layout: 'baseline', contents: [ { type: 'text', text: 'วันที่', weight: 'bold' }, { type: 'text', text: recordedDate, weight: 'bold', align: 'end' } ] }, { type: 'box', layout: 'baseline', contents: [ { type: 'text', text: 'เวลา', weight: 'bold' }, { type: 'text', text: recordedTime, weight: 'bold', size: 'xl', color: '#EF2F14FF', align: 'end' } ] } ] }, { type: 'separator' }, { type: 'box', layout: 'vertical', spacing: 'xs', margin: 'sm', contents: [ { type: 'text', text: 'สถานที่', weight: 'bold', size: 'sm', margin: 'md' }, { type: 'text', text: location, wrap: true } ] } ] } } };
                
                await liff.sendMessages([flexMessage]);
                liff.closeWindow();

            } catch (error) {
                console.error("Failed to send Flex Message:", error);
                Swal.fire('ส่งข้อความไม่สำเร็จ', `เกิดข้อผิดพลาด: ${error.message}`, 'error');
            }
        }

        // --- Geolocation ---
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(displayLocation, (error) => alert(`Geolocation error: ${error.message}`));
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function displayLocation(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            latitudeInput.value = latitude;
            longitudeInput.value = longitude;
            document.getElementById("latitude").innerText = `Latitude: ${latitude.toFixed(6)}`;
            document.getElementById("longitude").innerText = `Longitude: ${longitude.toFixed(6)}`;
            
            const reverseGeocodingUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
            fetch(reverseGeocodingUrl)
                .then(response => response.json())
                .then(data => {
                    const fullAddress = data.display_name || "Unable to retrieve full address.";
                    document.getElementById("fullAddress").innerText = `ที่อยู่ของคุณ: ${fullAddress}`;
                    fullAddressInput.value = fullAddress;
                })
                .catch(error => {
                    console.error("Error fetching reverse geocoding data:", error);
                    document.getElementById("fullAddress").innerText = "Error fetching address.";
                });

            document.getElementById("mapIframe").src = `https://maps.google.com/maps?q=${latitude},${longitude}&z=15&output=embed`;
        }
        
        // --- Step Navigation ---
        let currentStep = 1;
        function nextStep() { if (currentStep < 3) { document.getElementById(`step${currentStep}`).style.display = 'none'; currentStep++; document.getElementById(`step${currentStep}`).style.display = 'block'; } }
        function prevStep() { if (currentStep > 1) { document.getElementById(`step${currentStep}`).style.display = 'none'; currentStep--; document.getElementById(`step${currentStep}`).style.display = 'block'; } }

        function checkPictureAndNextStep() {
            const capturedImage = document.getElementById('preview').src;
            if (!capturedImage || capturedImage.includes('No-Image-Placeholder')) {
                Swal.fire('แจ้งเตือน!', 'กรุณาถ่ายรูปก่อนที่จะไปยังขั้นตอนถัดไป', 'warning');
            } else {
                nextStep();
            }
        }

        // --- Google Sheets Data Fetching ---
        const apimapKey = 'AIzaSyAHc1bZMPXE9NehuqgmjuWPsXpGds9wUCE';
        const spreadsheet2Id = '1gErfBELM6hSGTqx0xapkAfdhRjZ_BK7zhXMdRcLWm2w';
        const apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheet2Id}/values/MEMBER?key=${apimapKey}`;

        async function fetchData() {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                const table = document.getElementById('data-table');
                table.innerHTML = '';
                if (data.values) {
                    data.values.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(cell => { const td = document.createElement('td'); td.textContent = cell; tr.appendChild(td); });
                        table.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        function searchData() {
            const filter = document.getElementById('userId').value.toUpperCase();
            const table = document.getElementById('data-table');
            const rows = table.getElementsByTagName('tr');
            for (let i = 0; i < rows.length; i++) {
                const cells = rows[i].getElementsByTagName('td');
                if (cells.length > 0 && (cells[0].textContent || cells[0].innerText).toUpperCase().indexOf(filter) > -1) {
                    document.getElementById('columnBData').value = cells[1] ? (cells[1].textContent || cells[1].innerText) : '';
                    document.getElementById('roleInput').value = cells[2] ? (cells[2].textContent || cells[2].innerText) : '';
                    document.getElementById('columnDData').value = cells[3] ? (cells[3].textContent || cells[3].innerText) : '';
                    break;
                }
            }
        }

        // --- App Initialization ---
        document.addEventListener("DOMContentLoaded", function () {
            todayInput.value = getFormattedDate();
            initializeLiff();
            fetchData();

            const video = document.getElementById("camera-preview");
            const startCameraBtn = document.getElementById("start-camera-btn");
            const captureBtn = document.getElementById("capture-btn");
            let stream;

            startCameraBtn.addEventListener("click", () => {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(videoStream => {
                        stream = videoStream;
                        video.srcObject = videoStream;
                        captureBtn.disabled = false;
                        video.style.display = "block";
                    })
                    .catch(error => console.error("Error accessing the camera: ", error));
            });

            captureBtn.addEventListener("click", () => {
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
                preview.src = canvas.toDataURL("image/png");
                video.style.display = "none";
            });

            document.querySelectorAll('input[name="switch-jop"]').forEach(radio => {
                radio.addEventListener('change', function() { jobInput.value = this.value; });
            });

            setInterval(() => {
                const now = new Date();
                const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const timeOptions = { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: false, timeZone: 'Asia/Bangkok' };
                document.getElementById('date').textContent = now.toLocaleDateString('th-TH', dateOptions);
                document.getElementById('time').textContent = now.toLocaleTimeString('en-US', timeOptions);
            }, 1000);
        });
    </script>
</body>
</html>
